<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard Management for New Assets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/logos/ubc-facilities_logo.jpg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      :root {
        --ubc-blue: #002145;
        --ubc-blue-light: #0055b7;
        --light-grey: #f4f7fb;
        --dark-grey: #2d2d2d;
        --border-color: #e5e7eb;
        --card-bg: #ffffff;
        --success-green: #28a745;
        --error-red: #dc3545;
      }

      body {
        background-color: var(--light-grey);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        color: var(--dark-grey);
      }
      
      #main-view, #analytics-view, #qr-pending-view, #operational-cost-view, #fls-assets-view {
        display: none;
      }

      .ubc-navbar {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
      }

      .ubc-brand {
        color: var(--ubc-blue) !important;
        font-weight: 600;
        font-size: 1.1rem;
      }
      
      .ubc-logo, .ubc-facilities-logo {
        height: 79px;
        transition: height 0.3s ease;
      }

      .page-title {
        color: var(--ubc-blue);
        font-weight: 700;
        transition: font-size 0.3s ease;
      }

      .page-subtitle {
        color: #5a6e82;
        font-size: 1.1rem;
        transition: font-size 0.3s ease;
      }

      .section-title {
        color: var(--ubc-blue);
        font-weight: 600;
        padding-bottom: 0.5rem;
        display: inline-block;
      }
      
      .card.tile {
        background-color: var(--card-bg);
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
      }

      .card.tile:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
      
      .capture-card-highlight {
          background-color: #B1D6FA !important;
      }
      
      .sdi-card-highlight {
          background-color: #D5E0E0 !important;
      }
      
      .card-title {
        color: var(--ubc-blue);
        font-weight: 600;
      }
      
      .ubc-btn {
        background-color: var(--ubc-blue);
        border: none;
        color: white;
        font-weight: 500;
        border-radius: 8px;
        padding: 0.6rem 1.2rem;
        transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      }

      .ubc-btn:hover {
        background-color: var(--ubc-blue-light);
        color: white;
        transform: translateY(-2px);
      }
      
      .ubc-btn-secondary {
        background-color: transparent;
        border: 1px solid var(--ubc-blue);
        color: var(--ubc-blue);
      }
      .ubc-btn-secondary:hover {
        background-color: var(--ubc-blue);
        color: white;
      }

      .ubc-footer {
        background-color: var(--ubc-blue);
        color: rgba(255, 255, 255, 0.8);
      }
      
      .task-runner-wrapper {
        min-height: 38px;
        flex-grow: 1;
      }
      .progress-bar-container {
        display: none;
        align-items: center;
        width: 100%;
      }
      .progress-track {
        flex-grow: 1;
        height: 8px;
        background-color: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
        position: relative;
      }
      .progress-bar-fill {
        width: 100%;
        height: 100%;
        border-radius: 4px;
        background-color: var(--ubc-blue-light);
        background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent);
        background-size: 20px 20px;
        animation: progress-bar-stripes 1s linear infinite;
      }
      .status-indicator {
        display: flex;
        align-items: center;
        margin-left: 12px;
        min-width: 80px;
      }
      .status-icon {
        display: none;
        margin-right: 4px;
      }
      .status-text {
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .progress-bar-container.success .progress-track { background-color: #d4edda; }
      .progress-bar-container.success .progress-bar-fill { background-image: none; background-color: var(--success-green); }
      .progress-bar-container.success .icon-success { display: inline-block; color: var(--success-green); }
      .progress-bar-container.success .status-text { color: var(--success-green); }

      .progress-bar-container.error .progress-track { background-color: #f8d7da; }
      .progress-bar-container.error .progress-bar-fill { background-image: none; background-color: var(--error-red); }
      .progress-bar-container.error .icon-error { display: inline-block; color: var(--error-red); }
      .progress-bar-container.error .status-text { color: var(--error-red); }

      @keyframes progress-bar-stripes {
        from { background-position: 20px 0; }
        to { background-position: 0 0; }
      }

      .application-card-grid {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(3, 1fr);
      }
      @media (max-width: 991.98px) {
        .application-card-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 767.98px) {
        .application-card-grid {
          grid-template-columns: 1fr;
        }
      }

      .analytics-card-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1.5rem;
      }
      @media (min-width: 992px) {
        .analytics-card-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      .analytics-card {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      @media (min-width: 992px) {
        .bar-chart-card {
           grid-column: span 1;
           grid-row: span 2;
        }
        .kpi-pie-wrapper {
          display: flex;
          flex-direction: column;
          gap: 1.5rem;
          grid-column: span 1;
          grid-row: span 2;
        }
      }

      .form-select-wrapper .form-select {
        border-radius: 8px;
      }

      .asset-table-container {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .asset-table {
        width: 100%;
        border-collapse: collapse;
      }
      
      .asset-table th, .asset-table td {
        padding: 0.75rem 3.0rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }
      
      .asset-table th {
        font-weight: 600;
        color: var(--ubc-blue);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .asset-table tbody tr:last-child td {
        border-bottom: none;
      }
      .asset-table tbody tr:hover {
        background-color: #f8f9fa;
      }
      
      #detailed-view .asset-table th,
      #detailed-view .asset-table td {
        white-space: nowrap;
        font-size: 0.875rem;
        padding: 0.6rem 0.8rem;
      }

      .col-shrink-center {
        width: 1%;
        white-space: nowrap !important;
        text-align: center !important;
      }
      
      @media (max-width: 768px) {
        .page-title { font-size: 2.2rem; }
        .page-subtitle { font-size: 1rem; }
        .ubc-logo, .ubc-facilities-logo { height: 63px; }
        .ubc-brand { font-size: 0.9rem; }
        main.container { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
      }
      
      .container-fluid-fls {
          max-width: 100% !important;
          padding-left: 2rem;
          padding-right: 2rem;
      }

      #fls-assets-view {
          min-width: 1400px;
      }
      
      tr.disabled {
          color: #6c757d; 
          background-color: #f8f9fa; 
      }
      tr.disabled .delete-row {
          cursor: not-allowed;
      }

      .btn-excel { background-color: #28a745; color: white; }
      .btn-excel:hover { background-color: #218838; color: white; }
      .btn-pdf { background-color: #dc3545; color: white; }
      .btn-pdf:hover { background-color: #c82333; color: white; }
      .btn-email { background-color: #007bff; color: white; }
      .btn-email:hover { background-color: #0069d9; color: white; }
      .btn-teams { background-color: #464775; color: white; }
      .btn-teams:hover { background-color: #313252; color: white; }
      
      #delete-selected-btn { background-color: #dc3545; border-color: #dc3545; }
      #delete-selected-btn:hover { background-color: #c82333; border-color: #bd2130; }
      
      #fls-assets-view .action-buttons {
          display: flex;
          flex-wrap: wrap;
          gap: 0.75rem;
          margin-bottom: 1.5rem;
      }
      
      #fls-assets-view .action-buttons .btn {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          font-weight: 500;
      }

      #fls-assets-view .filter-container {
          display: flex;
          flex-wrap: nowrap;
          gap: 1rem;
          align-items: center;
          padding: 1rem;
          background-color: white;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
          margin-bottom: 1.5rem;
      }
      
      #fls-assets-view .filter-container .search-wrapper {
          flex-grow: 0.5; 
          min-width: 150px;
      }
      
      #fls-assets-view .filter-container .input-group {
          width: 100%;
      }
      
      #fls-assets-view .filter-container > div {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          flex-shrink: 0;
      }
      
      #fls-assets-view .filter-container label {
          margin-bottom: 0;
          white-space: nowrap;
      }
      
      #fls-assets-view .filter-container .form-select,
      #fls-assets-view .filter-container .form-control {
          min-width: 150px;
      }
      
      #fls-assets-view .filter-container #property-filter {
          min-width: 105px; 
      }

      #fls-assets-view .filter-container #reset-filters-btn {
          background: none;
          border: none;
          color: var(--ubc-blue);
      }
      #fls-assets-view .filter-container #reset-filters-btn:hover {
          background-color: var(--light-grey);
      }
      
      #fls-assets-view .table-container {
          background-color: var(--card-bg);
          border-radius: 16px;
          padding: 1.5rem;
          box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
          overflow-x: auto;
      }
      
      #fls-assets-view #asset-table {
          width: 100%;
          border-collapse: collapse;
      }

      #fls-assets-view #asset-table th,
      #fls-assets-view #asset-table td {
          padding: 0.75rem 1rem;
          text-align: left;
          border-bottom: 1px solid var(--border-color);
          white-space: nowrap;
          font-size: 0.875rem;
      }
      
      #fls-assets-view #asset-table th {
          font-weight: 600;
          color: var(--ubc-blue);
          font-size: 0.9rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }
      
      #fls-assets-view #asset-table tbody tr:last-child td {
          border-bottom: none;
      }
      
      #fls-assets-view #asset-table tbody tr:hover {
          background-color: #f8f9fa;
      }
      
      #fls-assets-view #asset-table .edit-row,
      #fls-assets-view #asset-table .delete-row {
          cursor: pointer;
          color: var(--ubc-blue-light);
      }
      #fls-assets-view #asset-table .delete-row {
          color: var(--error-red);
      }
      #fls-assets-view #asset-table .delete-row.disabled {
          color: #6c757d;
          cursor: not-allowed;
      }
      #fls-assets-view #asset-table .edit-row.disabled {
          color: #6c757d;
          cursor: not-allowed;
      }

      #asset-modal-bootstrap .modal-header {
          background-color: var(--ubc-blue);
          color: white;
      }
      #asset-modal-bootstrap .modal-title {
          color: white;
      }
      #asset-modal-bootstrap .modal-header .btn-close {
          filter: invert(1) grayscale(100%) brightness(200%);
      }
      
      #asset-form {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 1rem 1.5rem;
      }
      #asset-form .form-group {
          margin-bottom: 0;
      }
      #asset-form .full-width {
          grid-column: span 2;
      }
      
      #asset-form input[readonly],
      #asset-form select[disabled] {
          background-color: #e9ecef;
          opacity: 1;
      }

      #asset-modal-bootstrap .modal-footer {
          justify-content: space-between;
      }
      
      #asset-modal-bootstrap .modal-footer #modal-cancel-btn {
          background-color: #6c757d;
          color: white;
          border: none;
      }
      #asset-modal-bootstrap .modal-footer #modal-cancel-btn:hover {
          background-color: #5a6268;
      }
      #asset-modal-bootstrap .modal-footer #modal-save-btn {
          background-color: #28a745;
          color: white;
          border: none;
      }
      #asset-modal-bootstrap .modal-footer #modal-save-btn:hover {
          background-color: #218838;
      }
    </style>
  </head>
  <body class="ubc-body">
    <header>
      <nav class="navbar navbar-expand-lg ubc-navbar sticky-top" aria-label="Primary">
        <div class="container d-flex justify-content-between align-items-center">
          <a class="navbar-brand d-flex align-items-center gap-md-3 gap-2" href="{{ url_for('main.index') }}">
            <img src="{{ url_for('static', filename='logos/ubc_logo.jpg') }}" alt="UBC Logo" class="ubc-logo" />
            <span class="ubc-brand d-none d-md-inline">Dashboard Management for New Assets</span>
          </a>
          <div class="d-flex align-items: center gap-md-3 gap-2">
             <img src="{{ url_for('static', filename='logos/ubc-facilities_logo.jpg') }}" alt="UBC Facilities Logo" class="ubc-facilities-logo" />
             <i data-lucide="circle-user-round" style="color: var(--ubc-blue);"></i>
             <a href="{{ url_for('main.change_password') }}" class="btn btn-sm btn-outline-secondary" title="Change Password">
                <i data-lucide="key-round" class="align-middle"></i>
             </a>
             <a href="{{ url_for('auth.logout') }}" class="btn btn-sm ubc-btn-secondary ms-2">Logout</a>
          </div>
        </div>
      </nav>
    </header>

    <main id="main" class="container py-5">
      
      <div id="main-view">
        <div class="mb-5">
          <h1 class="display-5 page-title">Dashboard</h1>
          <p class="lead page-subtitle">Welcome, <strong>{{ username }}</strong>! Overview of applications and monitoring tools.</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-4">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show rounded-3" role="alert">
                  {{ message|safe }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        
        <section class="mb-5">
          <h2 class="h4 section-title mb-4">Applications</h2>
          <div class="application-card-grid">
            {% for a in apps %}
            <div class="d-flex">
              <div class="card tile h-100 w-100 {% if a.key == 'capture' %}capture-card-highlight{% elif a.key == 'sdi_process' %}sdi-card-highlight{% endif %}">
                <div class="card-body d-flex flex-column p-4">
                   <div class="mb-3"> <i data-lucide="box" style="color: var(--ubc-blue-light);" width="32" height="32"></i> </div>
                  <h3 class="h5 card-title mb-2">{{ a.name }}</h3>
                  <p class="card-text text-muted small mb-4"><code>{{ a.url | replace('https://', '') }}</code></p>
                  <div class="mt-auto d-flex gap-2 flex-wrap align-items-center">
                    <a class="btn ubc-btn" target="_blank" href="{{ a.url }}">Open</a>
                    {% if a.key in ["review_bf", "review_me", "review_el"] %}
                      <div class="task-runner-wrapper">
                        <div class="task-runner-container">
                            <div class="d-grid">
                                <button class="btn btn-outline-secondary btn-sm run-task-btn" type="button" data-task-key="qr_api_{{ a.key.split('_')[1] }}"> Run AI Interpreter </button>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-track"><div class="progress-bar-fill"></div></div>
                                <div class="status-indicator">
                                    <i data-lucide="check-circle" class="status-icon icon-success"></i>
                                    <i data-lucide="x-circle" class="status-icon icon-error"></i>
                                    <span class="status-text"></span>
                                </div>
                            </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}

            <div class="d-flex">
              <div class="card tile h-100 w-100">
                <div class="card-body d-flex flex-column p-4">
                  <div class="mb-3">
                    <i data-lucide="link" style="color: var(--ubc-blue-light);" width="32" height="32"></i>
                  </div>
                  <h3 class="h5 card-title mb-3">Useful Links</h3>
                  <div class="d-flex flex-column gap-2">
                    <div>
                      <a href="https://ubc-prod.planoncloud.com" target="_blank" class="text-decoration-none d-flex align-items-center gap-2">
                        <i data-lucide="external-link" width="16" height="16"></i>
                        <span class="fw-medium">Planon</span>
                      </a>
                    </div>
                    <div>
                      <a href="https://online-services.technicalsafetybc.ca" target="_blank" class="text-decoration-none d-flex align-items-center gap-2">
                        <i data-lucide="external-link" width="16" height="16"></i>
                        <span class="fw-medium">TSBC Website</span>
                      </a>
                    </div>
                    <div>
                      <a href="https://shareit.it.ubc.ca/teams/Teams/EMMS/Documents/Forms/AllItems.aspx" target="_blank" class="text-decoration-none d-flex align-items-center gap-2">
                        <i data-lucide="external-link" width="16" height="16"></i>
                        <span class="fw-medium">SDI Templates</span>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
        </section>

        <section class="mb-5">
          <h2 class="h4 section-title mb-4">Tasks & Monitoring</h2>
          <div class="row g-4 align-items-stretch">
        
            <div class="col-12 col-lg-4 d-flex">
              <div class="card tile h-100 w-100">
                <div class="card-body d-flex flex-column p-4">
                   <div class="mb-3">
                     <i data-lucide="database-zap" style="color: var(--ubc-blue-light);" width="32" height="32"></i>
                   </div>
                  <h3 class="h5 card-title mb-2">Database Sync</h3>
                  <p class="card-text text-muted small mb-4">Process new photos & JSON files to update the asset database.</p>
                  <div class="mt-auto task-runner-wrapper">
                    <div class="task-runner-container">
                        <div class="d-grid">
                            <button class="btn ubc-btn-secondary run-task-btn" type="button" data-task-key="update_db">
                              {{ task_labels.update_db or 'Run Database Update' }}
                            </button>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-track"><div class="progress-bar-fill"></div></div>
                            <div class="status-indicator">
                                <i data-lucide="check-circle" class="status-icon icon-success"></i>
                                <i data-lucide="x-circle" class="status-icon icon-error"></i>
                                <span class="status-text"></span>
                            </div>
                        </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        
            <div class="col-12 col-lg-8 d-flex">
              <div class="card tile h-100 w-100 p-4">
                  <h3 class="h5 card-title mb-4">Monitoring</h3>
                   <div class="d-flex flex-wrap align-items-center justify-content-start gap-4">
                      <div>
                        <a id="show-qr-pending-btn" role="button" title="Open QR Pending List" style="cursor: pointer;">
                          <img src="{{ url_for('static', filename='System Process Logs.png') }}" alt="Open QR Pending" width="200" height="200" style="max-width: 100%; height: auto; border-radius: 8px;">
                        </a>
                      </div>
                      <div>
                        <a id="show-analytics-btn" role="button" title="Open charts" style="cursor: pointer;">
                          <img src="{{ url_for('static', filename='Asset Reviewer Management.png') }}" alt="Open Analytics" width="200" height="200" style="max-width: 100%; height: auto; border-radius: 8px;">
                        </a>
                      </div>
                      <div>
                        <a id="show-operational-cost-btn" role="button" title="Open Operational Cost" style="cursor: pointer;">
                          <img src="{{ url_for('static', filename='QR Code Asset Management.png') }}" alt="Open Operational Cost" width="200" height="200" style="max-width: 100%; height: auto; border-radius: 8px;">
                        </a>
                      </div>
                      <div>
                        <div class="card h-100 position-relative" style="width: 200px; height: 200px; border-radius: 8px; background-color: #e9ecef;">
                            <a id="show-fls-assets-btn" role="button" title="Open FLS Assets" class="text-decoration-none d-flex flex-column justify-content-center align-items-center h-100 position-relative">
                                <i data-lucide="clipboard-list" style="color: var(--ubc-blue); width: 64px; height: 64px;"></i>
                                <span class="mt-2 fw-bold" style="color: var(--ubc-blue);">FLS Assets</span>
                                 <span id="fls-assets-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 1rem; margin-top: 1rem; margin-left: -1rem;">
                                    <span class="visually-hidden">incomplete items</span>
                                 </span>
                            </a>
                        </div>
                      </div>
                   </div>
              </div>
            </div>
        
          </div>
        </section>
        
      </div>

      <div id="analytics-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 page-title">Asset Reviewer Analysis</h1>
            <button id="back-to-main-btn" class="btn ubc-btn-secondary">Back to Dashboard</button>
        </div>

        <div class="d-flex flex-wrap align-items-center justify-content-end mb-4 gap-3">
            <div class="col-12 col-md-5 col-lg-4 form-select-wrapper">
              <select id="building" name="building" class="form-select">
                {% for opt in building_options %} <option value="{{ opt }}" {% if opt == selected_building %}selected{% endif %}>{{ opt }}</option> {% endfor %}
              </select>
            </div>
        </div>
        
        {% if chart_enabled %}
          <div class="analytics-card-grid">
              <div class="analytics-card bar-chart-card">
                  <img class="img-fluid" alt="Bar Chart" src="{{ url_for('main.approval_chart', building=selected_building, chart_type='bar') }}&ts={{ ts }}" style="width: 100%; height: 100%; object-fit: fill;">
              </div>
              <div class="kpi-pie-wrapper">
                  <div class="analytics-card kpi-card"> <img class="img-fluid" alt="Gauge Chart" src="{{ url_for('main.approval_chart', building=selected_building, chart_type='gauge') }}&ts={{ ts }}"> </div>
                  <div class="analytics-card pie-chart-card"> <img class="img-fluid" alt="Donut Chart" src="{{ url_for('main.approval_chart', building=selected_building, chart_type='pie') }}&ts={{ ts }}"> </div>
              </div>
          </div>
        {% else %}
          <div class="alert alert-warning rounded-3"> Chart unavailable{% if charts_error %}: {{ charts_error }}{% endif %}. </div>
        {% endif %}
      </div>

      <div id="qr-pending-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 page-title">QR Pending to AI Process</h1>
            <button id="back-to-main-btn-qr" class="btn ubc-btn-secondary">Back to Dashboard</button>
        </div>
        
        <section class="mb-5">
          <div id="summary-view">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="h4 section-title mb-0">Pending Summary</h2>
              <button id="toggle-to-detailed-btn" class="btn ubc-btn-secondary btn-sm">View Detailed List</button>
            </div>
            <div class="asset-table-container">
              {% if ai_status_summary %}
                <table class="asset-table">
                  <thead>
                    <tr>
                      <th>Property</th>
                      <th class="col-shrink-center">Pending Quantity</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in ai_status_summary %}
                      <tr>
                        <td>{{ row.Property or 'N/A' }}</td>
                        <td class="col-shrink-center">{{ row['Pendency QTY'] }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              {% else %}
                <div class="text-center p-4"><p class="text-muted mb-0">No pending asset data to display.</p></div>
              {% endif %}
            </div>
          </div>

          <div id="detailed-view" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <h2 class="h4 section-title mb-0">Detailed Pending Assets</h2>
              <button id="toggle-to-summary-btn" class="btn ubc-btn-secondary btn-sm">Back to Summary</button>
            </div>
            <div class="asset-table-container table-responsive">
              {% if ai_asset_details %}
                <table class="asset-table">
                  <thead><tr>{% for key in ai_asset_details[0].keys() %}<th>{{ key }}</th>{% endfor %}</tr></thead>
                  <tbody>
                    {% for asset in ai_asset_details %}<tr>{% for value in asset.values() %}<td>{{ value or 'N/A' }}</td>{% endfor %}</tr>{% endfor %}
                  </tbody>
                </table>
              {% else %}
                <div class="text-center p-4"><p class="text-muted mb-0">No detailed asset data to display.</p></div>
              {% endif %}
            </div>
          </div>
        </section>

        <section class="mb-5">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="h4 section-title mb-0">Recent Logs</h2>
            </div>
            <div class="asset-table-container">
                {% if recent_logs %}
                <table class="asset-table">
                    <thead>
                    <tr>
                        <th>Title</th>
                        <th>When</th>
                        <th class="text-end">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for log in recent_logs %}
                        <tr>
                        <td>{{ log.title }}</td>
                        <td>{{ log.when }}</td>
                        <td class="text-end">
                            <a href="{{ url_for('main.read_log', name=log.name) }}" class="btn ubc-btn-secondary btn-sm">View</a>
                        </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <div class="text-center mt-4">
                    <a href="{{ url_for('main.list_logs', from='monitoring') }}" class="btn ubc-btn">View All Logs</a>
                </div>
                {% else %}
                <div class="text-center p-4">
                    <p class="text-muted mb-0">No recent logs found.</p>
                </div>
                {% endif %}
            </div>
        </section>
      </div>
      
      <div id="operational-cost-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 page-title">QR Code Asset Management</h1>
            <button id="back-to-main-btn-op" class="btn ubc-btn-secondary">Back to Dashboard</button>
        </div>
        
        <div class="d-flex flex-wrap align-items-center justify-content-end mb-4 gap-3">
            <div class="col-12 col-md-5 col-lg-4 form-select-wrapper">
              <select id="building-operational-cost-slicer" name="building" class="form-select">
                {% for opt in building_options %}
                  <option value="{{ opt }}" {% if opt == selected_building %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
        </div>

        {% if operational_cost_chart_enabled %}
          <div class="row g-4">
            <div class="col-12 col-md-6">
              <div class="analytics-card">
                <img id="op-chart-weighted-avg" class="img-fluid" alt="Weighted Average Time" src="{{ url_for('main.operational_cost_chart', type='weighted_avg_time', building=selected_building) }}&ts={{ ts }}">
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="analytics-card">
                <img id="op-chart-ai-cost" class="img-fluid" alt="AI Estimated Cost" src="{{ url_for('main.operational_cost_chart', type='ai_cost', building=selected_building) }}&ts={{ ts }}">
              </div>
            </div>
            <div class="col-12">
              <div class="analytics-card">
                <img id="op-chart-combo" class="img-fluid" alt="Daily Operational Chart" src="{{ url_for('main.operational_cost_chart', type='combo', building=selected_building) }}&ts={{ ts }}">
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-warning rounded-3">Operational cost charts are unavailable.</div>
        {% endif %}

        <section class="mt-5 mb-5">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <h2 class="h4 section-title mb-0">AI Data Completeness Score</h2>
          </div>
          {% if completeness_chart_enabled %}
            <div class="d-flex flex-wrap align-items-center justify-content-start mb-4 gap-3">
              <div class="col-12 col-md-5 col-lg-4 form-select-wrapper">
                <label for="building-completeness-slicer" class="form-label fw-bold">Select a Building to see the score:</label>
                <select id="building-completeness-slicer" class="form-select">
                  {% for opt in building_options %}
                    <option value="{{ opt }}" {% if opt == 'All' %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div id="completeness-chart-container" class="analytics-card" style="display: flex;">
              <img id="completeness-chart-img" class="img-fluid" alt="Completeness Score Chart" src="{{ url_for('main.completeness_chart', building='All') }}&ts={{ ts }}">
            </div>
          {% else %}
            <div class="alert alert-warning rounded-3">
              Completeness Score chart is unavailable.
            </div>
          {% endif %}
        </section>
      </div>

      <div id="fls-assets-view">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-5 page-title">FLS New Device Entry</h1>
            <button id="back-to-main-btn-fls" class="btn ubc-btn-secondary">Back to Dashboard</button>
        </div>

        <div class="mb-5">
            <h2 class="section-title d-flex align-items-center gap-2 mb-3">
                <i data-lucide="bar-chart-3"></i>
                Devices in Process - Monitor
            </h2>
            <div class="card">
                <div class="card-body p-0">
                    <iframe id="charts-iframe" src="{{ url_for('main.fls_charts') }}" style="width: 100%; height: 650px; border: none;" title="FLS Charts"></iframe>
                </div>
            </div>
        </div>
        
        <h2 class="section-title d-flex align-items-center gap-2 mb-3">
            <i data-lucide="table"></i>
            Device Administration
        </h2>
        
        <div class="action-buttons">
            <button id="add-row-btn" class="btn ubc-btn">
                <i data-lucide="plus-circle"></i> Add New Asset
            </button>
            <button id="delete-selected-btn" class="btn" style="display: none;"> <i data-lucide="trash-2"></i> Delete Selected
            </button>
            <button id="export-btn" class="btn btn-excel" title="Export to Excel">
                <i data-lucide="file-spreadsheet"></i> Excel
            </button>
            <button id="pdf-btn" class="btn btn-pdf" title="Download as PDF">
                <i data-lucide="file-text"></i> PDF
            </button>
            <button id="email-pdf-btn" class="btn btn-email" title="Email as PDF">
                 <i data-lucide="mail"></i> Email PDF
            </button> 
            <button id="teams-btn" class="btn btn-teams" title="Post to Teams">
                <i data-lucide="send"></i> Post to Teams
            </button>
        </div>
        
        <div class="filter-container">
            <div class="search-wrapper">
                <div class="input-group">
                    <span class="input-group-text"><i data-lucide="search"></i></span>
                    <input type="text" id="global-search-input" class="form-control" placeholder="Search across all fields...">
                </div>
            </div>
            <div>
                <label for="status-filter">Status:</label>
                <select id="status-filter" class="form-select">
                    <option value="" selected>All</option>
                    <option value="0">Ongoing</option> 
                    <option value="1">Approved</option>
                </select>
            </div>
            <div>
                <label for="workflow-filter">Workflow:</label>
                <select id="workflow-filter" class="form-select">
                    <option value="" selected>All</option>
                </select>
            </div>
            <div>
                <label for="property-filter">Property:</label>
                <select id="property-filter" class="form-select">
                    <option value="">All</option>
                    </select>
            </div>
            <div>
                <label for="start-date-filter">Date From:</label>
                <input type="date" id="start-date-filter" class="form-control">
            </div>
            <div>
                <label for="end-date-filter">Date To:</label>
                <input type="date" id="end-date-filter" class="form-control">
            </div>
            <button id="reset-filters-btn" class="btn" title="Reset Filters">
                <i data-lucide="rotate-ccw"></i> Reset
            </button>
        </div>
        
        <div id="message-container"></div>
    
        <div class="table-container">
            <table id="asset-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox" class="form-check-input" title="Select All Visible"></th>
                        <th>Work Order</th>
                        <th>Asset Tag</th>
                        <th>Asset Group</th>
                        <th>Description</th>
                        <th>Property</th>
                        <th>Space</th>
                        <th>Space Details</th>
                        <th>Attribute Set</th>
                        <th>Device Address</th>
                        <th>Device Type</th>
                        <th>UN Account Number</th>
                        <th>Planon Code</th>
                        <th>Creation Date</th> 
                        <th>Status</th>
                        <th>Workflow</th>
                        <th>Actions</th>
                        <th>Duplicate</th>
                        <th>Delete</th>
                    </tr>
                 </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>

        <div class="modal fade" id="delete-confirm-modal-bootstrap" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel"><i data-lucide="alert-triangle" class="me-2"></i> Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                 <p id="delete-confirm-message" class="mb-0">Are you sure you want to delete this row?</p>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn ubc-btn-secondary" data-bs-dismiss="modal" id="cancel-delete-btn">Cancel</button>
                <button type="button" class="btn ubc-btn-danger" id="confirm-delete-btn">Delete</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal fade" id="asset-modal-bootstrap" tabindex="-1" aria-labelledby="assetModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered"> <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title">Edit Asset</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="asset-form" onsubmit="return false;" novalidate>
                            <input type="hidden" id="modal-asset-index">
                            
                            <div class="form-group">
                                <label for="modal-work-order">Work Order *</label>
                                <input type="text" id="modal-work-order" class="form-control">
                                <div class="invalid-feedback">Work Order is required.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-asset-tag">Asset Tag *</label>
                                <input type="text" id="modal-asset-tag" class="form-control">
                                <div class="invalid-feedback">Asset Tag is required.</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-property">Property *</label>
                                <select id="modal-property" class="form-select"></select>
                                <div class="invalid-feedback">Property is required.</div>
                            </div>
    
                            <div class="form-group">
                                <label for="modal-space">Space</label>
                                <select id="modal-space" class="form-select" disabled>
                                    <option value="">Select property first...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-space-details">Space Details</label>
                                <input type="text" id="modal-space-details" class="form-control">
                                <div class="invalid-feedback">Space Details is required for this workflow.</div>
                            </div>
                            <div class="form-group">
                                <label for="modal-asset-group">Asset Group</label>
                                <select id="modal-asset-group" class="form-select"></select>
                            </div>
    
                            <div class="form-group">
                                <label for="modal-un-account">UN Account Number</label>
                                <input type="text" id="modal-un-account" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-planon-code">Planon Code</label>
                                <input type="text" id="modal-planon-code" class="form-control">
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="modal-description">Description</label>
                                <input type="text" id="modal-description" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-device-address">Device Address</label>
                                <input type="text" id="modal-device-address" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-device-type">Device Type</label>
                                <input type="text" id="modal-device-type" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-attribute-set">Attribute Set</label>
                                <input type="text" id="modal-attribute-set" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-status">Status</label>
                                <select id="modal-status" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="0">Ongoing</option> 
                                    <option value="1">Approved</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-creation-date">Creation Date</label>
                                <input type="text" id="modal-creation-date" class="form-control" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label for="modal-workflow">Workflow</label>
                                <select id="modal-workflow" class="form-select">
                                </select>
                            </div>
    
                        </form>
                        </div>
                    <div class="modal-footer">
                        <span class="me-auto text-muted fst-italic"><small>* Mandatory Information.</small></span>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-cancel-btn">Cancel</button>
                        <button type="button" class="btn btn-success" id="modal-save-btn">Save Asset</button>
                    </div>
                    </div>
            </div>
        </div>

        <div class="modal fade" id="bulk-edit-modal-bootstrap" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bulk-edit-modal-title">Bulk Edit Assets</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Apply changes to <strong id="bulk-edit-count">0</strong> selected assets. Only checked fields will be updated.</p>
                        <form id="bulk-edit-form" onsubmit="return false;">
                            <div class="input-group mb-3">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" data-target="bulk-modal-property" aria-label="Checkbox for enabling property edit">
                                </div>
                                <select id="bulk-modal-property" class="form-select" disabled></select>
                            </div>
                            <div class="input-group mb-3">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" data-target="bulk-modal-space" aria-label="Checkbox for enabling space edit">
                                </div>
                                <select id="bulk-modal-space" class="form-select" disabled>
                                    <option value="">Select property first...</option>
                                </select>
                            </div>
                            <div class="input-group mb-3">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" data-target="bulk-modal-status" aria-label="Checkbox for enabling status edit">
                                </div>
                                <select id="bulk-modal-status" class="form-select" disabled>
                                    <option value="">Select Status...</option>
                                    <option value="0">Ongoing</option>
                                    <option value="1">Approved</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" data-target="bulk-modal-workflow" aria-label="Checkbox for enabling workflow edit">
                                </div>
                                <select id="bulk-modal-workflow" class="form-select" disabled>
                            </div>
                        </form>
                    </div>
    
                    <div class="modal-footer"><button type="button" class="btn ubc-btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn ubc-btn-success" id="bulk-modal-save-btn">Apply Changes</button></div>
                </div>
            </div>
        </div>
      </div>

    </main>

    <footer class="ubc-footer text-center py-4 mt-5">
      <div class="container">
        <small class="footer-text"> &copy; 2025 University of British Columbia - Maintenance Planning Department. All rights reserved. </small>
      </div>
    </footer>
    
    <script>
        lucide.createIcons();

        document.getElementById('building').addEventListener('change', function() {
            window.location.href = `{{ url_for('main.index') }}?building=${this.value}#analytics-view`;
        });
        
        const summaryView = document.getElementById('summary-view');
        const detailedView = document.getElementById('detailed-view');
        const toDetailedBtn = document.getElementById('toggle-to-detailed-btn');
        const toSummaryBtn = document.getElementById('toggle-to-summary-btn');

        if (toDetailedBtn) {
          toDetailedBtn.addEventListener('click', () => {
              summaryView.style.display = 'none';
              detailedView.style.display = 'block';
          });
        }

        if (toSummaryBtn) {
          toSummaryBtn.addEventListener('click', () => {
              detailedView.style.display = 'none';
              summaryView.style.display = 'block';
          });
        }

        document.querySelectorAll('.run-task-btn').forEach(button => {
            button.addEventListener('click', function() {
                const taskKey = this.dataset.taskKey;
                const runnerContainer = this.closest('.task-runner-container');
                const progressBarContainer = runnerContainer.querySelector('.progress-bar-container');
                
                this.parentElement.style.display = 'none';
                progressBarContainer.style.display = 'flex';
                progressBarContainer.querySelector('.status-text').textContent = 'Running...';
                
                fetch(`/run/${taskKey}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            pollLogStatus(data.log_name, progressBarContainer);
                        } else {
                            showError(progressBarContainer, 'Failed to start.');
                        }
                    })
                    .catch(() => showError(progressBarContainer, 'Network error.'));
            });
        });

        function pollLogStatus(logName, progressBarContainer) {
            const interval = setInterval(() => {
                fetch(`/log_status/${logName}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            clearInterval(interval);
                            showSuccess(progressBarContainer, logName);
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            showError(progressBarContainer, 'Task failed.');
                        }
                    })
                    .catch(() => {
                        clearInterval(interval);
                        showError(progressBarContainer, 'Polling failed.');
                    });
            }, 2000);
        }

        function showSuccess(progressBarContainer, logName) {
            progressBarContainer.classList.remove('error');
            progressBarContainer.classList.add('success');
            progressBarContainer.querySelector('.status-text').textContent = 'Success';
            lucide.createIcons();
            setTimeout(() => {
                window.location.href = `/logs/read?name=${logName}&mode=summary`;
            }, 1000);
        }

        function showError(progressBarContainer, message) {
            progressBarContainer.classList.remove('success');
            progressBarContainer.classList.add('error');
            progressBarContainer.querySelector('.status-text').textContent = message;
            lucide.createIcons();
            setTimeout(() => resetComponent(progressBarContainer), 5000);
        }

        function resetComponent(progressBarContainer) {
            const runnerContainer = progressBarContainer.closest('.task-runner-container');
            const buttonWrapper = runnerContainer.querySelector('.d-grid');

            progressBarContainer.style.display = 'none';
            progressBarContainer.classList.remove('success', 'error');
            buttonWrapper.style.display = 'block';
        }

        // --- View Toggling Logic ---
        const mainView = document.getElementById('main-view');
        const analyticsView = document.getElementById('analytics-view');
        const qrPendingView = document.getElementById('qr-pending-view');
        const operationalCostView = document.getElementById('operational-cost-view');
        const flsAssetsView = document.getElementById('fls-assets-view');
        
        // Get a reference to the <main> element
        const mainElement = document.getElementById('main'); 

        const showAnalyticsBtn = document.getElementById('show-analytics-btn');
        const showQrPendingBtn = document.getElementById('show-qr-pending-btn');
        const showOperationalCostBtn = document.getElementById('show-operational-cost-btn');
        const showFlsAssetsBtn = document.getElementById('show-fls-assets-btn');

        const backToMainBtn = document.getElementById('back-to-main-btn');
        const backToMainBtnQr = document.getElementById('back-to-main-btn-qr');
        const backToMainBtnOp = document.getElementById('back-to-main-btn-op');

        function handleViewSwitch() {
            const hash = window.location.hash;
            mainView.style.display = 'none';
            analyticsView.style.display = 'none';
            qrPendingView.style.display = 'none';
            operationalCostView.style.display = 'none';
            flsAssetsView.style.display = 'none';
            
            // Remove the wide-view class by default
            mainElement.classList.remove('container-fluid-fls'); 

            if (hash === '#qr-pending-view') {
                qrPendingView.style.display = 'block';
            } else if (hash === '#analytics-view') {
                analyticsView.style.display = 'block';
            } else if (hash === '#operational-cost-view') {
                operationalCostView.style.display = 'block';
            } else if (hash === '#fls-assets-view') {
                flsAssetsView.style.display = 'block';
                
                // Add the wide-view class ONLY for the FLS view
                mainElement.classList.add('container-fluid-fls'); 
                
            } else {
                mainView.style.display = 'block';
            }
            window.scrollTo(0, 0);
        }

        if (showAnalyticsBtn) {
            showAnalyticsBtn.addEventListener('click', (event) => {
                event.preventDefault();
                window.location.hash = 'analytics-view';
            });
        }

        if (showQrPendingBtn) {
            showQrPendingBtn.addEventListener('click', (event) => {
                event.preventDefault();
                window.location.hash = 'qr-pending-view';
            });
        }

        if (showOperationalCostBtn) {
            showOperationalCostBtn.addEventListener('click', (event) => {
                event.preventDefault();
                window.location.hash = 'operational-cost-view';
            });
        }

        if (showFlsAssetsBtn) {
            showFlsAssetsBtn.addEventListener('click', (event) => {
                event.preventDefault();
                window.location.hash = 'fls-assets-view';
            });
        }

        if (backToMainBtn) {
            backToMainBtn.addEventListener('click', () => { window.location.hash = ''; });
        }
        if (backToMainBtnQr) {
            backToMainBtnQr.addEventListener('click', () => { window.location.hash = ''; });
        }
        if (backToMainBtnOp) {
            backToMainBtnOp.addEventListener('click', () => { window.location.hash = ''; });
        }
        const backToMainBtnFls = document.getElementById('back-to-main-btn-fls');
        if (backToMainBtnFls) {
            backToMainBtnFls.addEventListener('click', () => { window.location.hash = ''; });
        }

        // --- Completeness Score Chart Logic ---
        const buildingCompletenessSlicer = document.getElementById('building-completeness-slicer');
        const completenessChartContainer = document.getElementById('completeness-chart-container');
        const completenessChartImg = document.getElementById('completeness-chart-img');

        if (buildingCompletenessSlicer) {
            buildingCompletenessSlicer.addEventListener('change', function() {
                const selectedBuilding = this.value;
                if (selectedBuilding) {
                    completenessChartImg.style.opacity = '0.5';
                    completenessChartContainer.style.display = 'flex';

                    const timestamp = new Date().getTime();
                    const chartUrl = `{{ url_for('main.completeness_chart') }}?building=${encodeURIComponent(selectedBuilding)}&ts=${timestamp}`;
                    
                    completenessChartImg.src = chartUrl;
                    
                    completenessChartImg.onload = () => {
                        completenessChartImg.style.opacity = '1';
                    };
                    completenessChartImg.onerror = () => {
                        completenessChartContainer.style.display = 'none';
                        console.error('Failed to load completeness chart.');
                    }
                } else {
                    completenessChartContainer.style.display = 'none';
                }
            });
        }
        
        // --- Operational Cost Chart Logic ---
        const opCostBuildingSlicer = document.getElementById('building-operational-cost-slicer');
        const opCharts = [
            document.getElementById('op-chart-weighted-avg'),
            document.getElementById('op-chart-ai-cost'),
            document.getElementById('op-chart-combo')
        ];

        if (opCostBuildingSlicer) {
            opCostBuildingSlicer.addEventListener('change', function() {
                const selectedBuilding = this.value;

                opCharts.forEach(chartImg => {
                    if (chartImg) {
                        chartImg.style.opacity = '0.5';
                        const url = new URL(chartImg.src);
                        url.searchParams.set('building', selectedBuilding);
                        url.searchParams.set('ts', new Date().getTime());
                        chartImg.src = url.toString();
                        
                        chartImg.onload = () => {
                            chartImg.style.opacity = '1';
                        };
                        chartImg.onerror = () => {
                            console.error(`Failed to load chart: ${chartImg.src}`);
                            chartImg.style.opacity = '1';
                        }
                    }
                });
            });
        }

        window.addEventListener('pageshow', handleViewSwitch);
        window.addEventListener('hashchange', handleViewSwitch);
    </script>

    <script>
        // --- Data from Flask for FLS Assets ---
        // This script will now fetch data dynamically
        document.addEventListener('DOMContentLoaded', () => {
            const flsView = document.getElementById('fls-assets-view');
            if (!flsView) return;

            // Only initialize the FLS script if the view is present
            initializeFlsAssets();
        });

        async function initializeFlsAssets() {
            try {
                const response = await fetch("{{ url_for('main.get_fls_asset_data') }}");
                if (!response.ok) {
                    throw new Error(`Failed to load FLS data: ${response.statusText}`);
                }
                const data = await response.json();
                
                // DEBUG: Log what we received from backend
                console.log("FLS Data from Backend:", {
                    asset_group_lookup_map_size: Object.keys(data.asset_group_lookup_map || {}).length,
                    asset_group_options_count: (data.asset_group_options || []).length,
                    existing_assets_count: (data.existing_assets || []).length,
                    first_asset: (data.existing_assets || [])[0],
                    first_few_lookup_keys: Object.keys(data.asset_group_lookup_map || {}).slice(0, 3)
                });
                
                // --- [NEW] Calculate and display the FLS assets badge count ---
                const incompleteCount = (data.existing_assets || []).filter(asset => {
                    const planonCode = asset.planon_code || '';
                    return !planonCode.trim();
                }).length;

                const badge = document.getElementById('fls-assets-badge');
                if (badge && incompleteCount > 0) {
                    badge.textContent = incompleteCount;
                    badge.style.display = 'block';
                } else if (badge) {
                    badge.style.display = 'none';
                }
                
                // [START OF CHANGE] - Pass the new 'filter_property_list'
                runFlsScript(
                    data.property_list || [],
                    data.filter_property_list || [], // <-- [NEW] Pass the new filter list
                    data.spaces_by_property || {},
                    data.device_type_map || {},
                    data.existing_assets || [],
                    data.asset_group_options || [], 
                    data.asset_group_lookup_map || {},
                    data.property_asset_tag_map || {},
                    data.property_name_to_code_map || {}
                );
                // [END OF CHANGE]

            } catch (error) {
                console.error("Error initializing FLS Assets:", error);
                const tableBody = document.getElementById('table-body');
                if(tableBody) {
                    tableBody.innerHTML = `<tr><td colspan="18" class="text-center text-danger p-4">Error: Could not load asset data. ${error.message}</td></tr>`;
                }
            }
        }

        // [START OF CHANGE] - Accept the new 'filterPropertyList'
        function runFlsScript(
            propertyList,       // This is the FULL list for the modal
            filterPropertyList, // This is the DISTINCT list from new_device for the filter
            spacesByPropertyData, 
            deviceTypeMapData, 
            existingAssets,
            assetGroupOptions,      
            assetGroupLookupMap,
            propertyAssetTagMap,
            propertyNameCodeMap
        ) {
        // [END OF CHANGE]
            
            lucide.createIcons();

            let currentAssets = {};
            existingAssets.forEach(asset => {
                currentAssets[asset.index] = asset;
            });
            let isNewAssetMode = false; // Flag to track modal mode
            const tableBody = document.getElementById('table-body');
            const messageContainer = document.getElementById('message-container');
            const statusFilter = document.getElementById('status-filter');
            
            const workflowFilter = document.getElementById('workflow-filter');
            
            const propertyFilter = document.getElementById('property-filter');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const resetFiltersBtn = document.getElementById('reset-filters-btn');
            const globalSearchInput = document.getElementById('global-search-input');
            const addRowBtn = document.getElementById('add-row-btn');
            const exportBtn = document.getElementById('export-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            const emailPdfBtn = document.getElementById('email-pdf-btn');
            const teamsBtn = document.getElementById('teams-btn');
            const bulkEditBtn = document.getElementById('bulk-edit-btn'); // This element is hidden in the new design but logic remains
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const assetModal = new bootstrap.Modal(document.getElementById('asset-modal-bootstrap'));
            const assetForm = document.getElementById('asset-form');
            const modalTitle = document.getElementById('modal-title');
            const modalIndex = document.getElementById('modal-asset-index');
            const modalWorkOrder = document.getElementById('modal-work-order');
            const modalAssetTag = document.getElementById('modal-asset-tag');
            const modalAssetGroup = document.getElementById('modal-asset-group');
            const modalDescription = document.getElementById('modal-description');
            const modalProperty = document.getElementById('modal-property');
            const modalSpace = document.getElementById('modal-space');
            
            const modalSpaceDetails = document.getElementById('modal-space-details');
            
            const modalAttributeSet = document.getElementById('modal-attribute-set');
            const modalDeviceAddress = document.getElementById('modal-device-address');
            const modalDeviceType = document.getElementById('modal-device-type');
            const modalUnAccount = document.getElementById('modal-un-account');
            const modalPlanonCode = document.getElementById('modal-planon-code');
            const modalCreationDate = document.getElementById('modal-creation-date');
            const modalStatus = document.getElementById('modal-status');
            const modalWorkflow = document.getElementById('modal-workflow');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            
            function updateFieldsFromAssetGroup(forceOverride = false) {
                const selectedAssetGroup = modalAssetGroup.value;
                const lookupData = assetGroupLookupMap[selectedAssetGroup];
                
                // DEBUG: Detailed logging
                console.log("updateFieldsFromAssetGroup called:", {
                    selectedAssetGroup,
                    lookupDataFound: !!lookupData,
                    lookupData: lookupData,
                    assetGroupLookupMapSize: Object.keys(assetGroupLookupMap).length,
                    firstFewKeys: Object.keys(assetGroupLookupMap).slice(0, 3),
                    forceOverride,
                    isNewAssetMode
                });

                // Description, Attribute Set, Device Address, and Device Type are READ-ONLY lookup fields
                // They should ALWAYS be populated from the assetGroupLookupMap based on the selected asset group
                // regardless of whether we're in new or edit mode
                if (lookupData) {
                    // Populate from lookup data
                    modalDescription.value = lookupData.description || '';
                    modalAttributeSet.value = lookupData.attribute_set || '';
                    modalDeviceAddress.value = lookupData.device_address || '';
                    modalDeviceType.value = lookupData.device_type || '';
                    console.log("Fields populated from lookup data");
                } else if (!selectedAssetGroup) {
                    // If no asset group selected (e.g., "Select..."), clear the fields
                    modalDescription.value = '';
                    modalAttributeSet.value = '';
                    modalDeviceAddress.value = '';
                    modalDeviceType.value = '';
                    console.log("No asset group selected, fields cleared");
                } else {
                    // Asset group selected but no lookup data found - leave fields as is
                    console.warn(`Asset group '${selectedAssetGroup}' selected but NOT FOUND in assetGroupLookupMap`);
                }
                
                updateWorkflowStatus();
            }

            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('delete-confirm-modal-bootstrap'));
            const deleteConfirmMessage = document.getElementById('delete-confirm-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            let pendingDeleteIndices = [];
            let pendingSingleDeleteIndex = null;
            
            // --- Bulk Edit Modal Elements ---
            const bulkEditModal = new bootstrap.Modal(document.getElementById('bulk-edit-modal-bootstrap'));
            const bulkModalSaveBtn = document.getElementById('bulk-modal-save-btn');
            const bulkEditForm = document.getElementById('bulk-edit-form');
            const bulkEditCount = document.getElementById('bulk-edit-count');
            const bulkModalProperty = document.getElementById('bulk-modal-property');
            const bulkModalSpace = document.getElementById('bulk-modal-space');
            const bulkModalStatus = document.getElementById('bulk-modal-status');
            const bulkModalWorkflow = document.getElementById('bulk-modal-workflow');


            function createReadOnlyRow(asset) {
                const row = document.createElement('tr'); row.dataset.index = asset.index;
                const getValue = (val) => val ?? '';
                const statusMap = {'0': 'Ongoing', '1': 'Approved'};
                const statusText = statusMap[String(asset.status)] || 'N/A';
                
                const planonCodeValue = getValue(asset.planon_code);
                
                // --- UPDATE: Full workflow logic now applied to table row ---
                let dynamicWorkflowText = '';
                if (planonCodeValue) {
                    dynamicWorkflowText = "Complete";
                } else if (!getValue(asset.asset_group) || !getValue(asset.space)) {
                    dynamicWorkflowText = "Electrical Team";
                } else {
                    dynamicWorkflowText = "Asset Management";
                }
                
                // Use the asset's stored workflow value if it exists, otherwise use the dynamic one
                const workflowToDisplay = getValue(asset.workflow) || dynamicWorkflowText;


                const deleteDisabledClass = planonCodeValue ? 'disabled' : '';
                const editDisabledClass = planonCodeValue ? 'disabled' : '';
                
                if (deleteDisabledClass) {
                    row.classList.add(deleteDisabledClass);
                }
                
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox form-check-input" ${planonCodeValue ? 'disabled' : ''}></td>
                    <td>${getValue(asset.work_order)}</td>
                    <td>${getValue(asset.asset_tag)}</td> 
                    <td>${getValue(asset.asset_group)}</td>
                    <td>${getValue(asset.description)}</td>
                    <td>${getValue(asset.property)}</td>
                    <td>${getValue(asset.space)}</td>
                    <td>${getValue(asset.space_details)}</td> <td>${getValue(asset.attribute_set)}</td>
                    <td>${getValue(asset.device_address)}</td>
                    <td>${getValue(asset.device_type)}</td>
                    <td>${getValue(asset.un_account_number)}</td>
                    <td>${planonCodeValue}</td>
                    <td>${getValue(asset.creation_date)}</td>
                    <td>${statusText}</td>
                    <td>${workflowToDisplay}</td> <td>
                        <a href="#" class="edit-row ${editDisabledClass}" title="${editDisabledClass ? 'Cannot edit - Planon Code exists' : 'Edit Asset'}">
                            <i data-lucide="edit" class="lucide"></i>
                        </a>
                        <a href="#" class="duplicate-row" title="Duplicate Asset" style="margin-left: 8px;">
                            <i data-lucide="copy" class="lucide"></i>
                        </a>
                    </td>
                    <td class="delete-row ${deleteDisabledClass}" title="${planonCodeValue ? 'Cannot delete - Planon Code exists' : 'Delete Row'}">
                        <i data-lucide="trash-2" class="lucide"></i>
                    </td>
                `;
                
                row.dataset.planonCode = planonCodeValue;
                return row;
            }

            function renderTable() {
                tableBody.innerHTML = '';
                const sortedIndices = Object.keys(currentAssets).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
                sortedIndices.forEach(index => {
                    tableBody.appendChild(createReadOnlyRow(currentAssets[index]));
                });
                lucide.createIcons();
                filterTable();
                updateActionButtons(); // Update button visibility after render
                selectAllCheckbox.checked = false;
            }

            function updateWorkflowStatus() {
                const planonCode = modalPlanonCode.value.trim();
                const assetGroup = modalAssetGroup.value; 
                const space = modalSpace.value;

                if (planonCode) {
                    modalWorkflow.value = "Complete";
                } else if (!assetGroup || !space) {
                    modalWorkflow.value = "Electrical Team";
                } else {
                    modalWorkflow.value = "Asset Management";
                }
            }
            
            function togglePlanonCodeEditability() {
                if (modalWorkflow.value === "Asset Management") {
                    modalPlanonCode.readOnly = false;
                    modalPlanonCode.title = '';
                } else {
                    modalPlanonCode.readOnly = true;
                    modalPlanonCode.title = 'Workflow must be "Asset Management" to edit the Planon Code.';
                }
            }

            function openModalForNew() {
                assetForm.reset();
                assetForm.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
                    el.classList.remove('is-invalid', 'is-valid');
                });
                isNewAssetMode = true; // Set flag
                modalTitle.innerText = 'Add New Asset';
                modalIndex.value = Date.now().toString() + Math.floor(Math.random() * 100);
                modalStatus.value = '0';
                modalSpace.innerHTML = '<option value="">Select property first...</option>';
                modalSpace.disabled = true;
                modalCreationDate.value = '(Will be set on save)';
                assetModal.show();
                
                updateWorkflowStatus();
                togglePlanonCodeEditability(); 
            }

            function openModalForEdit(index) {
                const asset = currentAssets[index];
                console.log("Opening modal for edit - Asset data from currentAssets:", asset);
                if (!asset) return;
                assetForm.reset();
                assetForm.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
                    el.classList.remove('is-invalid', 'is-valid');
                });
                isNewAssetMode = false; // Set flag
                modalTitle.innerText = 'Edit Asset';
                modalIndex.value = asset.index;
                modalWorkOrder.value = asset.work_order || '';
                modalAssetTag.value = asset.asset_tag || '';
                
                const assetGroupName = asset.asset_group || '';
                console.log("Asset group from database:", assetGroupName);
                let matchingOptionValue = '';
                if (assetGroupName) {
                    for (let option of modalAssetGroup.options) {
                        if (option.value.startsWith(assetGroupName + ' | ') || option.value === assetGroupName) {
                            matchingOptionValue = option.value;
                            console.log("Found matching dropdown option:", matchingOptionValue);
                            break;
                        }
                    }
                    if (!matchingOptionValue) {
                        console.warn(`No matching dropdown option found for asset group: '${assetGroupName}'`);
                    }
                }
                modalAssetGroup.value = matchingOptionValue;
                console.log("Set modalAssetGroup.value to:", matchingOptionValue);

                modalSpaceDetails.value = asset.space_details || '';
                
                modalProperty.value = asset.property || '';
                modalDeviceAddress.value = asset.device_address || '';
                modalDeviceType.value = asset.device_type || '';
                modalUnAccount.value = asset.un_account_number || '';
                modalPlanonCode.value = asset.planon_code || '';
                modalCreationDate.value = asset.creation_date || '';
                modalStatus.value = String(asset.status ?? "");
                
                // Load the saved workflow value
                modalWorkflow.value = asset.workflow || '';
                
                populateSpaceDropdown(asset.property, asset.space); 
                
                // Call updateFieldsFromAssetGroup to populate Description and Attribute Set from the lookup map
                console.log("About to call updateFieldsFromAssetGroup");
                updateFieldsFromAssetGroup(); 
                
                assetModal.show();
 
                // Update workflow status *after* loading, in case it needs to be overridden
                // (e.g., if it was 'Electrical Team' but is now 'Complete')
                updateWorkflowStatus();
                
                togglePlanonCodeEditability();
            }
            
            function openModalForDuplicate(index) {
                const asset = currentAssets[index];
                if (!asset) return;
                
                openModalForEdit(index); // First, load all data just like an edit
                
                // Now, override fields for duplication
                isNewAssetMode = true; // It's a "new" asset
                modalTitle.innerText = 'Duplicate Asset';
                
                // Get a new unique index
                modalIndex.value = Date.now().toString() + Math.floor(Math.random() * 100);
                
                // Clear fields that should not be copied
                modalPlanonCode.value = '';
                modalCreationDate.value = '(Will be set on save)';
                
                // Set default status for a new asset
                modalStatus.value = '0'; // Ongoing
                
                // Re-run the status/workflow logic
                updateWorkflowStatus();
                togglePlanonCodeEditability(); 
            }

            function populateSpaceDropdown(selectedProperty, selectedSpace = null) {
                modalSpace.disabled = !selectedProperty;
                modalSpace.innerHTML = selectedProperty ? '<option value="">Select Space...</option>' : '<option value="">Select property first...</option>';
                if (selectedProperty) {
                    const spaces = spacesByPropertyData[selectedProperty] || [];
                    spaces.sort().forEach(space => {
                        modalSpace.innerHTML += `<option value="${space}" ${selectedSpace === space ? 'selected' : ''}>${space}</option>`;
                    });
                }
            }

            async function saveModalData() {
                const workOrder = modalWorkOrder.value.trim();
                const assetTag = modalAssetTag.value.trim();
                const property = modalProperty.value;

                let isValid = true;
                [modalWorkOrder, modalAssetTag, modalProperty, modalSpaceDetails].forEach(el => {
                    el.classList.remove('is-invalid', 'is-valid');
                });
                
                if (!workOrder) {
                    modalWorkOrder.classList.add('is-invalid');
                    isValid = false;
                } else {
                    modalWorkOrder.classList.add('is-valid');
                }
                if (!assetTag) {
                    modalAssetTag.classList.add('is-invalid');
                    isValid = false;
                } else {
                    modalAssetTag.classList.add('is-valid');
                }
                if (!property) {
                    modalProperty.classList.add('is-invalid');
                    isValid = false;
                } else {
                    modalProperty.classList.add('is-valid');
                }
                
                // --- [NEW VALIDATION CHECK] ---
                const workflow = modalWorkflow.value;
                const spaceDetails = modalSpaceDetails.value.trim();
                
                if (workflow === "Asset Management" && !spaceDetails) {
                    alert("Please set the Space Details value before saving asset"); 
                    modalSpaceDetails.classList.add('is-invalid');
                    isValid = false; 
                }
                // --- [END NEW VALIDATION CHECK] ---

                if (!isValid) {
                    return; 
                }

                const assetGroupSelectedOption = modalAssetGroup.value;
                const assetGroupName = assetGroupSelectedOption ? assetGroupSelectedOption.split(' | ')[0] : '';

                const asset = {
                    'index': modalIndex.value, 
                    'work_order': workOrder, 
                    'asset_tag': assetTag,
                    'asset_group': assetGroupName, 
                    'description': modalDescription.value.trim(), 
                    'property': property,
                    'space': modalSpace.value, 
                    'space_details': modalSpaceDetails.value.trim(), // Send the editable value
                    'attribute_set': modalAttributeSet.value.trim(), 
                    'device_address': modalDeviceAddress.value.trim(),
                    'device_type': modalDeviceType.value.trim(),
                    'un_account_number': modalUnAccount.value.trim(), 
                    'planon_code': modalPlanonCode.value.trim(),
                    'status': modalStatus.value, 
                    'workflow': modalWorkflow.value 
                };
                
                try {
                    modalSaveBtn.disabled = true;
                    const response = await fetch("{{ url_for('main.add_fls_assets') }}", {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify([asset])
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        const savedAsset = result.assets[0];
                        currentAssets[savedAsset.index] = savedAsset;
                        renderTable();
                        assetModal.hide();
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message || 'An unknown error occurred.', 'error');
                    }
                } catch (error) {
                    showMessage(`Network error: ${error.message}`, 'error');
                } finally {
                    modalSaveBtn.disabled = false;
                }
            }

            function showMessage(message, type) {
                messageContainer.textContent = message;
                messageContainer.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
                messageContainer.style.display = 'block';
                if (type === 'success') setTimeout(() => { messageContainer.style.display = 'none'; }, 4000);
            }

            function filterTable() {
                let statusValue = statusFilter.value;
                if (statusValue === "Ongoing") statusValue = "0";
                else if (statusValue === "Approved") statusValue = "1";
                
                const workflowValue = workflowFilter.value; // Get workflow filter value
                const propertyValue = propertyFilter.value;
                const searchValue = globalSearchInput.value.toLowerCase();
                
                const startDateValue = startDateFilter.value;
                const endDateValue = endDateFilter.value;

                const startDate = startDateValue ? new Date(startDateValue + 'T00:00:00') : null;
                const endDate = endDateValue ? new Date(endDateValue + 'T23:59:59') : null;

                tableBody.querySelectorAll('tr').forEach(row => {
                    const asset = currentAssets[row.dataset.index];
                    let show = true;
                    
                    if (statusValue && String(asset.status) !== statusValue) show = false;
                    
                    // Handle workflow filtering.
                    const assetWorkflow = asset.workflow || ''; // Use empty string if null/undefined
                    if (workflowValue && assetWorkflow !== workflowValue) {
                        // Special case: if user filters for "Complete", "Asset Management", or "Electrical Team",
                        // and the asset's saved workflow is empty, we must check the *calculated* value.
                        
                        let calculatedWorkflow = '';
                        if (asset.planon_code) {
                            calculatedWorkflow = "Complete";
                        } else if (!asset.asset_group || !asset.space) {
                            calculatedWorkflow = "Electrical Team";
                        } else {
                            calculatedWorkflow = "Asset Management";
                        }
                        
                        // If the asset's *saved* workflow is different from the filter
                        // AND the *calculated* workflow is ALSO different, then hide it.
                        if (assetWorkflow !== workflowValue && calculatedWorkflow !== workflowValue) {
                            show = false;
                        }
                    }
                    
                    if (propertyValue && asset.property !== propertyValue) show = false;
                    
                    if (show && (startDate || endDate) && asset.creation_date) {
                        try {
                            const parts = asset.creation_date.split('/');
                            if (parts.length === 3) {
                                const assetDate = new Date(parts[2], parts[0] - 1, parts[1]);
                                if (startDate && assetDate < startDate) show = false;
                                if (endDate && assetDate > endDate) show = false;
                            } else {
                                if(startDate || endDate) show = false; 
                            }
                        } catch (e) {
                            console.warn("Invalid date format for asset:", asset.index, asset.creation_date);
                            if(startDate || endDate) show = false; 
                        }
                    }
                    
                    if (show && searchValue && !Object.values(asset).join(' ').toLowerCase().includes(searchValue)) show = false;
                    
                    row.style.display = show ? '' : 'none';
                });
            }

            // [START OF CHANGE]
            function initializeModalDropdowns() {
                modalAssetGroup.innerHTML = '<option value="">Select...</option>' + assetGroupOptions.map(g => `<option value="${g}">${g}</option>`).join('');
                
                // Use the FULL list (propertyList) for the MODAL
                modalProperty.innerHTML = '<option value="">Select...</option>' + propertyList.sort().map(p => `<option value="${p}">${p}</option>`).join('');
                
                // Use the NEW FILTER list (filterPropertyList) for the FILTER
                propertyFilter.innerHTML = '<option value="">All</option>' + filterPropertyList.map(p => `<option value="${p}">${p}</option>`).join('');

                const workflowOptions = [
                    // "New", "Assigned", "In Progress", "Pending", // Removed as per request
                    "Electrical Team", "Asset Management", "Complete" // From new logic
                ];
                
                const uniqueWorkflowOptions = [...new Set(workflowOptions)].sort(); // Sorted
                
                // Populate modal
                modalWorkflow.innerHTML = '<option value="">Select...</option>' + uniqueWorkflowOptions.map(w => `<option value="${w}">${w}</option>`).join('');
                
                // Populate filter (workflowFilter is available in this scope)
                workflowFilter.innerHTML = '<option value="" selected>All</option>' + uniqueWorkflowOptions.map(w => `<option value="${w}">${w}</option>`).join('');
            }
            // [END OF CHANGE]

            async function executeDelete() {
                const indices = pendingDeleteIndices.length > 0 ? pendingDeleteIndices : (pendingSingleDeleteIndex ? [pendingSingleDeleteIndex] : []);
                if (indices.length === 0) return;
                try {
                    const response = await fetch("{{ url_for('main.delete_fls_assets') }}", {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ indices })
                    });
                    const result = await response.json();
                    if (response.ok && result.success) {
                        indices.forEach(index => { delete currentAssets[index]; });
                        renderTable();
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message || 'Error deleting rows.', 'error');
                    }
                } catch (error) {
                    showMessage(`Network error: ${error.message}`, 'error');
                } finally {
                    deleteConfirmModal.hide();
                    pendingDeleteIndices = [];
                    pendingSingleDeleteIndex = null;
                }
            }
            
            // --- Bulk Edit Functions ---
            
            function updateActionButtons() {
                const selectedCount = tableBody.querySelectorAll('.row-checkbox:checked').length;
                if (selectedCount > 0) {
                    deleteSelectedBtn.style.display = 'inline-block';
                    if (bulkEditBtn) bulkEditBtn.style.display = 'inline-block'; // Keep check for safety
                } else {
                    deleteSelectedBtn.style.display = 'none';
                    if (bulkEditBtn) bulkEditBtn.style.display = 'none';
                }
            }

            function populateBulkSpaceDropdown(selectedProperty) {
                bulkModalSpace.disabled = !selectedProperty;
                bulkModalSpace.innerHTML = selectedProperty ? '<option value="">Select Space...</option>' : '<option value="">Select property first...</option>';
                
                if (selectedProperty) {
                    const spaces = spacesByPropertyData[selectedProperty] || [];
                    spaces.sort().forEach(space => {
                        bulkModalSpace.innerHTML += `<option value="${space}">${space}</option>`;
                    });
                }
            }

            function openBulkEditModal() {
                const selectedIndices = Array.from(tableBody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.closest('tr').dataset.index);
                
                if (selectedIndices.length === 0) {
                    showMessage("No rows selected for bulk edit.", "error");
                    return;
                }

                bulkEditCount.textContent = selectedIndices.length;

                // Populate dropdowns by copying from the single-edit modal
                bulkModalProperty.innerHTML = modalProperty.innerHTML;
                bulkModalStatus.innerHTML = modalStatus.innerHTML;
                bulkModalWorkflow.innerHTML = modalWorkflow.innerHTML;
                
                // Reset form state
                bulkEditForm.reset();
                bulkEditForm.querySelectorAll('select').forEach(sel => sel.disabled = true);
                bulkModalSpace.innerHTML = '<option value="">Select property first...</option>'; // Special case for space
                
                bulkEditModal.show();
            }

            async function saveBulkEditData() {
                const updates = {};
                
                // Map from modal select ID to DB column name
                const fieldMap = {
                    'bulk-modal-property': 'Property',
                    'bulk-modal-space': 'Space',
                    'bulk-modal-status': 'Status',
                    'bulk-modal-workflow': 'Workflow'
                };

                bulkEditForm.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    const targetId = checkbox.dataset.target;
                    const targetSelect = document.getElementById(targetId);
                    const columnName = fieldMap[targetId];
                    
                    if (columnName && targetSelect.value !== "") {
                        updates[columnName] = targetSelect.value;
                    }
                });

                if (Object.keys(updates).length === 0) {
                    showMessage("No changes selected to apply.", "error");
                    return;
                }
                
                const indices = Array.from(tableBody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.closest('tr').dataset.index);

                const payload = {
                    indices: indices,
                    updates: updates
                };

                try {
                    bulkModalSaveBtn.disabled = true;
                    const response = await fetch("{{ url_for('main.bulk_update_assets') }}", {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // Update local data store with returned assets
                        result.assets.forEach(asset => {
                            currentAssets[asset.index] = asset;
                        });
                        renderTable(); // Re-render the table with updated data
                        bulkEditModal.hide();
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message || 'An unknown error occurred.', 'error');
                    }

                } catch (error) {
                    showMessage(`Network error: ${error.message}`, 'error');
                } finally {
                    bulkModalSaveBtn.disabled = false;
                }
            }

            // --- Add Event Listeners for Bulk Edit ---
            if (bulkEditBtn) bulkEditBtn.addEventListener('click', openBulkEditModal); // Check if exists
            bulkModalSaveBtn.addEventListener('click', saveBulkEditData);

            // Add listeners to modal checkboxes to enable/disable dropdowns
            bulkEditForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const targetId = e.target.dataset.target;
                    const targetSelect = document.getElementById(targetId);
                    if (targetSelect) {
                        targetSelect.disabled = !e.target.checked;
                        // If checking property, and it's already populated, enable space
                        if(targetId === 'bulk-modal-property' && e.target.checked) {
                             populateBulkSpaceDropdown(targetSelect.value);
                        }
                    }
                });
            });

            // Add listener to property dropdown to populate space dropdown
            bulkModalProperty.addEventListener('change', (e) => {
                populateBulkSpaceDropdown(e.target.value);
            });


            // --- Original Event Listeners ---
            addRowBtn.addEventListener('click', openModalForNew);
            modalSaveBtn.addEventListener('click', saveModalData);
            confirmDeleteBtn.addEventListener('click', executeDelete);
            
            // Add workflowFilter to the list of event listeners
            [statusFilter, workflowFilter, propertyFilter, globalSearchInput, startDateFilter, endDateFilter].forEach(el => 
                el.addEventListener('input', filterTable)
            );
            
            resetFiltersBtn.addEventListener('click', () => {
                statusFilter.value = 'Ongoing'; 
                workflowFilter.value = ''; // Reset workflow filter
                propertyFilter.value = ''; 
                globalSearchInput.value = ''; 
                startDateFilter.value = ''; 
                endDateFilter.value = '';   
                filterTable();
            });
            
            selectAllCheckbox.addEventListener('click', () => {
                tableBody.querySelectorAll('tr .row-checkbox:not(:disabled)').forEach(cb => {
                    if (cb.closest('tr').style.display !== 'none') cb.checked = selectAllCheckbox.checked;
                });
                updateActionButtons(); 
            });
            
            deleteSelectedBtn.addEventListener('click', () => {
                pendingDeleteIndices = Array.from(tableBody.querySelectorAll('.row-checkbox:checked')).map(cb => cb.closest('tr').dataset.index);
                if (pendingDeleteIndices.length > 0) {
                    deleteConfirmMessage.textContent = `Are you sure you want to delete ${pendingDeleteIndices.length} selected row(s)?`;
                    deleteConfirmModal.show();
                } else {
                    showMessage("No rows selected.", "error");
                }
            });
            
            // [START] MODIFIED TABLE CLICK LISTENER
            tableBody.addEventListener('click', (event) => {
                const target = event.target.closest('a.edit-row, a.duplicate-row, td.delete-row');
                if (!target) return;

                const row = target.closest('tr');
                if (!row) return;

                const index = row.dataset.index;

                if (target.matches('.edit-row')) {
                    if (target.classList.contains('disabled')) {
                        event.preventDefault();
                        showMessage('This asset cannot be edited because it already has a Planon Code.', 'error');
                        return;
                    }
                    event.preventDefault();
                    openModalForEdit(index);
                } else if (target.matches('.duplicate-row')) {
                    event.preventDefault();
                    openModalForDuplicate(index);
                } else if (target.matches('.delete-row')) {
                    if (target.classList.contains('disabled')) {
                        event.preventDefault();
                        return;
                    }
                    pendingSingleDeleteIndex = index;
                    pendingDeleteIndices = [];
                    deleteConfirmMessage.textContent = `Are you sure you want to delete the asset with Work Order "${currentAssets[index].work_order}"?`;
                    deleteConfirmModal.show();
                }
            });
            // [END] MODIFIED TABLE CLICK LISTENER
            
            modalProperty.addEventListener('change', (e) => {
                populateSpaceDropdown(e.target.value);
                
                if (isNewAssetMode) {
                   modalAttributeSet.value = '';
                }

                // --- [NEW LOGIC] ---
                // Set UN Account Number based on the selected property
                const selectedPropertyName = e.target.value;
                const propertyCode = propertyNameCodeMap[selectedPropertyName];

                // Use the property code to look up the asset tag
                if (propertyCode && propertyAssetTagMap[propertyCode]) {
                    modalUnAccount.value = propertyAssetTagMap[propertyCode];
                } else {
                    modalUnAccount.value = '';
                }
                togglePlanonCodeEditability();
                updateWorkflowStatus(); 
            });

            modalAssetGroup.addEventListener('change', (e) => {
                
                const selectedOptionText = e.target.value;
                const assetTagValue = modalAssetTag.value.trim();

                let assetGroupName = '';
                let fullClassification = null;

                if (selectedOptionText) {
                    const parts = selectedOptionText.split(' | ');
                    assetGroupName = parts[0] ? parts[0].trim() : '';
                    fullClassification = parts[1] ? parts[1].trim() : null;
                }
                
                if (isNewAssetMode) {
                    if (assetTagValue) {
                        modalDescription.value = `${assetGroupName} - ${assetTagValue}`;
                    } else {
                        modalDescription.value = assetGroupName;
                    }

                    if (fullClassification && deviceTypeMapData[fullClassification]) {
                        modalDeviceType.value = deviceTypeMapData[fullClassification];
                    } else {
                        modalDeviceType.value = '';
                    }
                } else {
                    // In edit mode, update ALL lookup fields from the asset group lookup map
                    updateFieldsFromAssetGroup();
                    
                    if (fullClassification && deviceTypeMapData[fullClassification]) {
                        modalDeviceType.value = deviceTypeMapData[fullClassification];
                    }
                }
                
                togglePlanonCodeEditability();
                updateWorkflowStatus();
            });
            
            modalAssetTag.addEventListener('input', (e) => {
                const assetTagValue = e.target.value.trim();
                
                modalDeviceAddress.value = assetTagValue;

                if (!isNewAssetMode) {
                    return;
                }

                const selectedOptionText = modalAssetGroup.value;
                
                if (!selectedOptionText) {
                    return;
                }

                const assetGroupName = selectedOptionText.split(' | ')[0];
                
                if (assetTagValue) {
                    modalDescription.value = `${assetGroupName} - ${assetTagValue}`;
                } else {
                    modalDescription.value = assetGroupName;
                }
            });
            
            modalSpace.addEventListener('change', () => {
                togglePlanonCodeEditability();
                updateWorkflowStatus();

                if (isNewAssetMode) {
                    if (modalSpace.value) {
                        modalAttributeSet.value = 'FireAlarmDevice';
                    } else {
                        modalAttributeSet.value = '';
                    }
                }
            });
            
            modalPlanonCode.addEventListener('input', () => {
                updateWorkflowStatus();
                togglePlanonCodeEditability();
            });
            
            // [NEW] Add listener to workflow dropdown to toggle editability when it changes.
            // The status change can also affect the workflow, so we listen to both.
            modalWorkflow.addEventListener('change', togglePlanonCodeEditability); 
            modalStatus.addEventListener('change', togglePlanonCodeEditability);

            // Initialization
            initializeModalDropdowns();
            existingAssets.forEach(asset => { currentAssets[asset.index] = asset; });
            renderTable();
            updateActionButtons(); 
        }
    </script>
  </body>
</html>